<head>
  <meta charset="UTF-8" />
  <title>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞</title>

  <!-- ‚úÖ –¢–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.0.6/dist/pizzip.min.js"></script>
  <script src="https://unpkg.com/docxtemplater@3.32.3/build/docxtemplater.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <link rel="stylesheet" href="./css/style.css">
</head>

<body>
  <h2>–î–æ–≥–æ–≤–æ—Ä Orzu Havas</h2>
  <div class="alert success" id="successAlert">‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!</div>
  <div class="alert error" id="errorAlert">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram.</div>

  <form id="contractForm">
    <div class="form-section">
      <input name="contractNumber" placeholder="–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞" required />
      <input name="contractCode" placeholder="–ë—É–∫–≤—ã –¥–æ–≥–æ–≤–æ—Ä–∞" required />
      <input name="fullName" placeholder="–§.–ò.–û –ü–æ–∫—É–ø–∞—Ç–µ–ª—è" required />
      <input name="passport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç" required />
      <input name="pinfl" placeholder="–ü–ò–ù–§–õ" required />
      <input name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="+998" required />
    </div>

    <div class="form-section">
      <label>–î–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:</label>
      <input type="date" name="firstPaymentDate" required />

      <label>–ü–µ—Ä–∏–æ–¥ —Ä–∞—Å—Å—Ä–æ—á–∫–∏ (–≤ –º–µ—Å—è—Ü–∞—Ö):</label>
      <select name="paymentPeriod" required>
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥</option>
        <option value="3">3 –º–µ—Å—è—Ü–∞</option>
        <option value="6">6 –º–µ—Å—è—Ü–µ–≤</option>
        <option value="12">12 –º–µ—Å—è—Ü–µ–≤</option>
        <option value="18">18 –º–µ—Å—è—Ü–µ–≤</option>
        <option value="24">24 –º–µ—Å—è—Ü–µ–≤</option>
      </select>
    </div>

    <div class="form-section">
      <h3>–¢–æ–≤–∞—Ä—ã</h3>
      <div id="products"></div>
      <button type="button" onclick="addProduct()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    </div>

    <button type="submit">üì§ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>

  <script>
    const form = document.getElementById("contractForm");
    const productsDiv = document.getElementById("products");
    const successAlert = document.getElementById("successAlert");
    const errorAlert = document.getElementById("errorAlert");

    function addProduct() {
      const index = productsDiv.children.length;
      const wrapper = document.createElement("div");
      wrapper.className = "product";
      wrapper.innerHTML = `
        <input name="productName_${index}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" required />
        <input name="productQty_${index}" type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" required />
        <input name="productPrice_${index}" type="number" step="0.01" placeholder="–¶–µ–Ω–∞ (—Å—É–º)" required />
        <button type="button" onclick="removeProduct(${index})">–£–¥–∞–ª–∏—Ç—å</button>
      `;
      productsDiv.appendChild(wrapper);
    }

    function removeProduct(index) {
      const product = productsDiv.children[index];
      product.remove();
      updateProductIndexes();
    }

    function updateProductIndexes() {
      const allProducts = productsDiv.querySelectorAll(".product");
      allProducts.forEach((prod, i) => {
        const inputs = prod.querySelectorAll("input");
        inputs.forEach(input => {
          input.name = input.name.replace(/\d+/, i);
        });
        const removeButton = prod.querySelector("button");
        removeButton.setAttribute("onclick", `removeProduct(${i})`);
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      successAlert.style.display = "none";
      errorAlert.style.display = "none";

      const formData = new FormData(form);
      const contractNumber = formData.get("contractNumber");
      const contractCode = formData.get("contractCode");
      const fullName = formData.get("fullName");
      const passport = formData.get("passport");
      const pinfl = formData.get("pinfl");
      const phone = formData.get("phone");
      const firstPaymentDate = formData.get("firstPaymentDate");
      const period = parseInt(formData.get("paymentPeriod"));

      const items = [];
      productsDiv.querySelectorAll(".product").forEach((prod, i) => {
        items.push({
          name: formData.get(`productName_${i}`),
          qty: parseInt(formData.get(`productQty_${i}`)),
          price: parseFloat(formData.get(`productPrice_${i}`))
        });
      });

      const total = items.reduce((sum, i) => sum + i.qty * i.price, 0);
      const monthly = +(total / period).toFixed(2);

      const dates = [];
      const base = new Date(firstPaymentDate);
      for (let i = 0; i < period; i++) {
        const d = new Date(base);
        d.setMonth(d.getMonth() + i);
        dates.push(d.toLocaleDateString("ru-RU"));
      }

      const data = {
    "–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞": contractNumber,
    "–ë—É–∫–≤—ã –¥–æ–≥–æ–≤–æ—Ä–∞": contractCode,
    "–§.–ò.–û –ü–æ–∫—É–ø–∞—Ç–µ–ª—è": fullName,
    "–ü–∞—Å–ø–æ—Ä—Ç": passport,
    "–ü–ò–ù–§–õ": pinfl,
    "–ù–æ–º–µ—Ä": phone,
    "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞": items.map(item => item.name).join("\n"),
    "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ": items.map(item => item.qty).join("\n"),
    "–¶–µ–Ω–∞": items.map(item => item.price.toLocaleString()).join("\n"),
    "–ì—Ä–∞—Ñ–∏–∫": dates.map((d, i) => `${i + 1}. ${d} ‚Äî ${monthly.toLocaleString()} —Å—É–º`).join("\n")
  };


      try {
        const response = await fetch("fixed.docx"); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
        const arrayBuffer = await response.arrayBuffer();
        const zip = new PizZip(arrayBuffer);

        const doc = new window.docxtemplater(zip, {
          paragraphLoop: true,
          linebreaks: true
        });

        doc.setData(data);
        doc.render();

        const out = doc.getZip().generate({
          type: "blob",
          mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        });

        const file = new File([out], `${fullName}-${contractNumber}-${contractCode}.docx`);

        const tgForm = new FormData();
        tgForm.append("chat_id", "-1002564003711");
        tgForm.append("caption", `–î–æ–≥–æ–≤–æ—Ä –æ—Ç ${fullName}\n#${contractNumber}`);
        tgForm.append("document", file);

        const tgResp = await fetch("https://api.telegram.org/bot7513506064:AAHTgZ6K08inhCAAAKm4Sb71r-6fbBFQo4M/sendDocument", {
          method: "POST",
          body: tgForm
        });

        if (tgResp.ok) {
          successAlert.style.display = "block";
          form.reset();
          productsDiv.innerHTML = "";
        } else {
          errorAlert.style.display = "block";
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞:", err);
        errorAlert.style.display = "block";
      }
    });
  </script>
</body>
