<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; }
    input, select, button { width: 100%; margin-bottom: 10px; padding: 8px; font-size: 1em; }
    .product { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
  </style>
</head>
<body>

  <h2>–§–æ—Ä–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞</h2>

  <form id="contractForm">
    <input name="contractNumber" placeholder="–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞" required />
    <input name="contractCode" placeholder="–ë—É–∫–≤—ã –¥–æ–≥–æ–≤–æ—Ä–∞" required />
    <input name="fullName" placeholder="–§.–ò.–û –ü–æ–∫—É–ø–∞—Ç–µ–ª—è" required />
    <input name="passport" placeholder="–ü–∞—Å–ø–æ—Ä—Ç" required />
    <input name="pinfl" placeholder="–ü–ò–ù–§–õ" required />
    <input name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required />

    <label>–î–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:</label>
    <input type="date" name="firstPaymentDate" required />

    <label>–ü–µ—Ä–∏–æ–¥ —Ä–∞—Å—Å—Ä–æ—á–∫–∏ (–≤ –º–µ—Å—è—Ü–∞—Ö):</label>
    <select name="paymentPeriod" required>
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥</option>
      <option value="3">3 –º–µ—Å—è—Ü–∞</option>
      <option value="6">6 –º–µ—Å—è—Ü–µ–≤</option>
      <option value="12">12 –º–µ—Å—è—Ü–µ–≤</option>
    </select>

    <h3>–¢–æ–≤–∞—Ä—ã</h3>
    <div id="products"></div>
    <button type="button" onclick="addProduct()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>

    <br />
    <button type="submit">üì§ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>

  <script>
    const form = document.getElementById("contractForm");
    const productsDiv = document.getElementById("products");
    const BOT_TOKEN = "7513506064:AAHTgZ6K08inhCAAAKm4Sb71r-6fbBFQo4M";
    const CHAT_ID = "-1002564003711";

    function addProduct() {
      const index = productsDiv.children.length;
      const wrapper = document.createElement("div");
      wrapper.className = "product";
      wrapper.innerHTML = `
        <input name="productName_${index}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" required />
        <input name="productQty_${index}" type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" required />
        <input name="productPrice_${index}" type="number" step="0.01" placeholder="–¶–µ–Ω–∞ (—Å—É–º)" required />
      `;
      productsDiv.appendChild(wrapper);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const contractNumber = formData.get("contractNumber");
      const contractCode = formData.get("contractCode");
      const fullName = formData.get("fullName");
      const passport = formData.get("passport");
      const pinfl = formData.get("pinfl");
      const phone = formData.get("phone");
      const firstPaymentDate = formData.get("firstPaymentDate");
      const period = parseInt(formData.get("paymentPeriod"));

      const items = [];
      productsDiv.querySelectorAll(".product").forEach((prod, i) => {
        items.push({
          name: formData.get(`productName_${i}`),
          qty: parseInt(formData.get(`productQty_${i}`)),
          price: parseFloat(formData.get(`productPrice_${i}`))
        });
      });

      const total = items.reduce((sum, i) => sum + i.qty * i.price, 0);
      const monthly = +(total / period).toFixed(2);

      const dates = [];
      const base = new Date(firstPaymentDate);
      for (let i = 0; i < period; i++) {
        const d = new Date(base);
        d.setMonth(d.getMonth() + i);
        dates.push(d.toLocaleDateString("ru-RU"));
      }

      const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell } = window.docx;

      const doc = new Document({
        sections: [{
          properties: {},
          children: [
            new Paragraph({ children: [new TextRun(`–î–æ–≥–æ–≤–æ—Ä ‚Ññ${contractNumber}-${contractCode}`),] }),
            new Paragraph({ children: [new TextRun(`–§.–ò.–û: ${fullName}`)] }),
            new Paragraph({ children: [new TextRun(`–ü–∞—Å–ø–æ—Ä—Ç: ${passport}`)] }),
            new Paragraph({ children: [new TextRun(`–ü–ò–ù–§–õ: ${pinfl}`)] }),
            new Paragraph({ children: [new TextRun(`–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}`)] }),
            new Paragraph({ text: " " }),
            new Paragraph("üì¶ –¢–æ–≤–∞—Ä—ã:"),
            new Table({
              rows: [
                new TableRow({
                  children: ["–ù–∞–∑–≤–∞–Ω–∏–µ", "–ö–æ–ª-–≤–æ", "–¶–µ–Ω–∞", "–°—É–º–º–∞"].map(text =>
                    new TableCell({ children: [new Paragraph(text)] })
                  )
                }),
                ...items.map(item =>
                  new TableRow({
                    children: [
                      new TableCell({ children: [new Paragraph(item.name)] }),
                      new TableCell({ children: [new Paragraph(item.qty.toString())] }),
                      new TableCell({ children: [new Paragraph(item.price.toLocaleString())] }),
                      new TableCell({ children: [new Paragraph((item.qty * item.price).toLocaleString())] }),
                    ]
                  })
                )
              ]
            }),
            new Paragraph({ text: " " }),
            new Paragraph("üí∞ –ì—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π:"),
            new Table({
              rows: [
                new TableRow({
                  children: ["#", "–î–∞—Ç–∞", "–°—É–º–º–∞"].map(text =>
                    new TableCell({ children: [new Paragraph(text)] })
                  )
                }),
                ...dates.map((d, i) =>
                  new TableRow({
                    children: [
                      new TableCell({ children: [new Paragraph((i + 1).toString())] }),
                      new TableCell({ children: [new Paragraph(d)] }),
                      new TableCell({ children: [new Paragraph(monthly.toLocaleString())] }),
                    ]
                  })
                )
              ]
            })
          ]
        }]
      });

      const blob = await Packer.toBlob(doc);
      const file = new File([blob], `–î–æ–≥–æ–≤–æ—Ä-${contractNumber}-${contractCode}.docx`);

      const tgForm = new FormData();
      tgForm.append("chat_id", CHAT_ID);
      tgForm.append("caption", `üìÑ –î–æ–≥–æ–≤–æ—Ä ‚Ññ${contractNumber}-${contractCode} –¥–ª—è ${fullName}`);
      tgForm.append("document", file);

      const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`, {
        method: "POST",
        body: tgForm
      });

      if (res.ok) {
        alert("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!");
        form.reset();
        productsDiv.innerHTML = "";
        addProduct();
      } else {
        alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram.");
      }
    });

    addProduct();
  </script>
</body>
</html>
